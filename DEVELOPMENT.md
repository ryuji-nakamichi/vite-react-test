# 開発記録と技術仕様 (Development Log)

本ドキュメントは、プロジェクトの設計仕様、デバッグ手法、および開発の軌跡を記録するものである。

---

## ◼︎ アプリケーション仕様・設計

### 1. クイズ機能 (Quiz System)
- **難易度設定**: 初級・中級・上級の3段階。
- **諸葛亮の助言 (Hint System)**: 
    - 4択のうち不正解の2つを消去する「50:50」機能を実装。
    - ゲーム中1回のみ使用可能。`hiddenChoices` ステートで制御。
- **状態管理**: `useState` を用いて、現在の問題番号、正答数、クイズ進行、ヒント使用状況を管理。

### 2. 武将図鑑と演出 (Encyclopedia & Visuals)
- **Web Monetization 連携**:
    - 支援開始を検知し `ThankYouToast` を表示。
    - `isMonetized` フラグにより、アプリ全体を「黄金モード（琥珀色の動的グラデーション背景）」へ切り替え。
- **デコード演出 (`DecodingText`)**:
    - 支援者限定データ表示時にシャッフルアニメーションを実行。
    - **安定化処理**: デコード中のみ `font-mono`（等幅フォント）を適用し、文字幅の変化による画面の揺れを抑制。
- **レスポンシブ設計**:
    - `max-w-6xl` のワイドレイアウト採用。
    - スマホ表示時、左右余白を最小化（`px-0`）し、コンテンツ領域を最大化。
    - `overflow-x-hidden` により、詳細画面での不要な横揺れを防止。

---

## 🛠 Web Monetization デバッグ手法

拡張機能による実際の支払いを待たずに、UIやロジックのテストを行うためのモックコード。

### 強制支援状態発動スクリプト (Console用)
ブラウザのデベロッパーツール（Console）に貼り付けて実行することで、支援開始イベントをシミュレートする。

```javascript
// 1. オブジェクトの存在確認と作成
if (!document.monetization) {
    document.monetization = document.createElement('div');
    document.monetization.state = 'pending';
}

// 2. 状態を「支援開始」に変更
document.monetization.state = 'started';

// 3. React側が監視しているイベントを強制発火
const startEvent = new CustomEvent('monetizationstart');
document.monetization.dispatchEvent(startEvent);

console.log('🚀 [SYSTEM] Web Monetization Mock Event: STARTED');
```


---

### ステップ2：後半をコピーして、ステップ1の直後に貼り付け
（開発タイムラインから環境構築メモの最後までです）

```markdown

---

## ⏳ 開発タイムライン (Changelog)

### 2025-11-01 〜 2025-11-03
- **プロジェクト発足**: React + Vite + Tailwind CSS の基本構成を構築。
- **クイズエンジン**: 難易度選択と問題遷移の基本ロジックを実装。

### 2026-01-03 〜 2026-01-04
- **PWA & Deploy**: PWA化（オフライン対応）の完了。
- **GitHub Pages**: `gh-pages` を利用した自動デプロイ環境の構築。

### 2026-01-07 〜 2026-01-10
- **収益化基盤**: GateHub口座開設、KYC（本人確認）の完了。
- **Payment Pointer**: `$ilp.gatehub.net/984080110/eur` を取得し、アプリへ結合。

### 2026-01-11
- **演出の極致**: `DecodingText` コンポーネントによる「軍略秘録」の解析演出を実装。
- **データ拡充**: 主要武将15名の「IT業界版パラレル設定（裏・人物評）」を完筆。
- **ドキュメント整理**: リファクタリングを完了。

### 2026-01-12

- UI/UX 革命: 支援状態に連動する「黄金モード」背景の実装。
- 機能拡張: クイズに「諸葛亮の助言（ヒント）」機能を追加。
- SP最適化:
  - 武将詳細画面の横スクロールを解消。
  - DecodingText の揺れを等幅フォントで修正。
  - 全体の幅を max-w-6xl に拡張。
- フィードバック: 支援開始時の「感謝トースト」コンポーネントを実装。

### 2026-01-17

#### 新機能のアイデア

##### 歴史切り替えスイッチ機能

- Gitのブランチみたいに、スイッチを選択してどう歴史が切り替わるかを楽しむ機能。


##### 中国大陸地図を表示して「もしこの勢力がこの場所を領土にできていたら」を検証考察できる機能

- 地図を表示、クリックできるようにしておく。
- 勢力モードを選択。例）蜀モードに選択。
- 蜀モードにて、本来蜀の領土ではなかったところを蜀が領有していたら、魏と呉はどういう行動を採らないといけなくなるかをシミュレートできる。
- 同様に魏モード、呉モードもできるようにする。

### 2026-01-18
- **歴史シミュレーションシステム (Timeline Repository) の実装**:
    - Gitのブランチ概念を導入した「仮想戦史シミュレーター」を新規構築。
    - `currentBranch` ステートによるアプリ全体のデータ動的切り替え機能を実装。
    - ターミナル風のチェックアウト演出（非同期ログ表示）により、エンジニアライクな没入感を強化。
- **シナリオとバタフライ・エフェクトの定義**:
    - 「樊城の戦い：関羽生存ルート (`win-fancheng`)」の実装。
    - 「夷陵の戦い：蜀軍勝利ルート (`win-yiling`)」の追加。
    - 関羽、劉備、曹操、陸遜の各武将データにIFシナリオ用の詳細テキスト（Bio）を拡充。
- **軍師称号システム (Strategist Title System) の導入**:
    - 訪問したブランチ数（歴史の観測度）に応じて称号が進化するロジックを実装。
    - 称号ランク（C, R, SR, SSR）と、それに連動したネームプレートUIをホーム画面に配置。
    - `visitedBranches` を用いた永続的な訪問フラグ管理（Appレベルでの状態管理）を構築。
- **UI/UX の洗練**:
    - ホーム画面に「絶対配置（Absolute）」を用いたステータスプレートを実装し、ゲーム性を視覚的に強調。
    - モード切り替えやブランチ切り替え時の整合性を確保するためのPropsリレーの最適化。

### 2026-01-24

#### ⚔️ 戦争シミュレーション・システムの基盤完成
- **合戦ロジックの実装**: 兵数・士気ゲージを連動させたフェーズ移行型戦闘エンジンの構築。
- **演出強化**: 勝利時の「武将カットイン（関羽）」およびメッセージエリアの動的カラーチェンジを実装。
- **遷移の最適化**: `useNavigate` を活用し、合戦終了からホームへの滑らかな帰還を実現。

#### 📜 称号システム（Title System）の高度化
- **称号結合ロジック**: クイズの成績（不敗、名高き等）と観測状況（歴史の観測者等）を組み合わせた `fullName` 表示システムを導入。
- **SSR称号解放**: 複数IFルートの観測および支援状態により「黄金の多元世界の覇道軍師」が解放されることを確認。

#### 🏗 構造のリファクタリング
- **合戦一覧画面（BattleList）の創設**: URL直接指定を廃止し、合戦場を選択して出陣する動線を整備。
- **ボタンコンポーネントの統一**: `Link` タグを `NavigationButton` へ置換し、DRY原則に基づいたクリーンな `Home.jsx` を実現。


### 2026-02-01 (Current)

#### 🎭 演出の極大化：合戦ナレーション機能の実装
- **プレリュード・システムの導入**: 合戦開始前に戦いの背景を説明するナレーション画面を実装。
- **タイピング・エフェクト**: テキストを一文字ずつ表示する演出により、レトロゲームおよび三國無双シリーズのような重厚な導入を実現。
- **データ構造の拡張**: `battles.js` に各シナリオ固有の背景テキスト（`prelude`）を保持するフィールドを追加。


#### 🏆 戦績連動システムの実装
- **クリア済みバッジの導入**: 合戦一覧画面において、制圧済みの戦場に「Cleared」バッジを表示するロジックを実装。
- **データ駆動型への改善**: `BATTLES` データに `branchId` を持たせ、バトル画面と一覧画面の判定を共通化。
- **UIフィードバックの強化**: クリア済みの戦場カードの配色を青系に変更し、歴史を塗り替えたことを視覚的に強調。


#### 🚩 「期間限定・軍令」システムの導入
- **ボーナスロジック**: 未クリアの合戦に限定して、初期士気が+20される「軍令」システムを実装。
- **視覚的ガイド**: `BattleList` において未クリア戦場にバウンスする軍令バッジを表示し、プレイヤーの導線を強化。

#### 🏹 新規合戦「夷陵の戦い」の追加
- **蜀軍シナリオ**: 劉備視点での対呉戦争を実装。火計の罠（IFルート）を盛り込んだ三段階のフェーズ構成。
- **データ連動**: `win-yiling` ブランチの解放条件を設定。

#### ⚔️ 合戦システムの完成度向上
- **動的カットインの実装**: 各合戦データに応じた武将のセリフ・カラーを動的に表示する仕組みを構築。夷陵の戦いでは劉備の魂の叫びが響くようになった。
- **UIの洗練（条件分岐）**: 決着（勝利/敗北）がついた際に「撤退ボタン」を非表示にするロジックを実装。プレイヤーの誤操作防止と没入感を両立。
- **ナレーション演出の高度化**: タイピング演出における改行コード（\n）への対応。歴史の重厚さを伝えるレイアウト調整を完了。

#### 🏹 新コンテンツ追加
- **「夷陵の戦い」全フェーズ実装**: 陸遜の火計ルートからIFの勝利までのデータ構造を完結。
- **アイコン連動システム**: 合戦ごとに「🗡️」「🔥」などのラベルとアイコンを出し分けるUIへリファクタリング。

#### 💾 システム基盤
- **LocalStorageによる歴史の永続化**: 解放したブランチ情報をブラウザに保存し、リロードしても称号や制圧状況が失われない環境を整備。


#### 🗺️ 戦略地図システム（Strategy Map）の導入

- SVGによる大陸地図の描画: HTMLベースのリスト表示に加え、SVGを用いた中国大陸の広域マップを実装。viewBox 属性の活用により、レスポンシブかつ高精細な地図表示を実現。

- 動的ステータス連動: visitedBranches（クリア済みフラグ）と地図上の座標を連動。制圧した拠点が「グレー（未踏）」から「青/赤（制圧済み）」へとリアルタイムに変化し、animate-ping による視覚的な達成感を演出。

- 地図と合戦のシームレスな統合: 地図上のマーカーをクリックすることで、対象の合戦画面へ直接遷移する「ダイレクト出陣機能」を実装。

##### 🎨 UI/UXの最適化

- 配置の再定義: 当初Home画面に配置していた戦略地図を、より「軍議」のコンテキストに近い「合戦一覧画面（BattleList）」へ移動。これにより、情報の優先順位を整理し、広々としたキャンバスでの戦況俯瞰が可能になった。

- 情報の可視化: 「Cleared」バッジ、軍令ボーナス、アイコン（🗡️, 🔥）を組み合わせ、現在の攻略目標が一目でわかるインターフェースへとリファクタリング。


##### 💾 システム基盤の強化

- データの永続化（LocalStorage）: ブラウザをリロードしても軍師の称号や制圧状況が失われないよう、App.jsx でのステート管理を永続化。

#### ⚔️ 魏・袁軍シナリオの拡張
- **「官渡の戦い」「合肥の戦い」の実装**: 魏軍視点の重要拠点データを追加。地図が中原から東方へと拡大した。
- **勢力動的表示システム**: 合戦データに基づき、参戦勢力（蜀・魏・呉・袁）を自動でレンダリングする仕組みを構築。

#### 📜 歴史豆知識ツールの実装
- **インタラクティブ・ツールチップ**: 勢力アイコンにホバーすることで、その勢力の詳細解説が表示される機能を実装。
- **UIスタッキングの最適化**: `overflow-hidden` による見切れ問題を解消し、没入感を削がないレイアウト調整を完了。

#### 🗺️ 戦略地図のリファクタリング
- **データ駆動型マッピング**: 拠点データを配列ループ（map）で描画する設計に変更。今後の戦場追加が容易な「疎結合」な構造へと進化した。

---

## 💡 今後の課題

- [ ] **支援者特典の更なる強化**: 黄金モード時、クイズのヒントを2回使えるように調整。
- [ ] **SE/BGMの実装**: 助言使用時の「扇の音」や、デコード中のシステム音。
- [ ] **クリアランク機能**: スコアに応じた称号（平民〜皇帝）の表示。

---

## 📋 付録：環境構築メモ (Environment Setup)

### 1. Node.js 環境の構築 (nvm)

- **nvm インストール**:
  ```bash
  $ brew install nvm
  $ mkdir ~/.nvm
  ```


- Xcode ライセンス同意:
`$ sudo xcodebuild -license accept`

- パス設定: `~/.zshrc` の末尾に追記。

```bash
export NVM_DIR="$HOME/.nvm"
[ -s "/usr/local/opt/nvm/nvm.sh" ] && \. "/usr/local/opt/nvm/nvm.sh"
```

- Node.js インストール:
`$ nvm install --lts`


### 2. プロジェクト初期化と Vite 導入
- Vite プロジェクト作成:
`$ npm create vite@6.2.1 .`

- パッケージインストール:
`$ npm install`

### 3. 主要パッケージの追加
- ルーティング: `$ npm install react-router-dom`
- スタイリング: `$ npm install -D tailwindcss postcss autoprefixer`
- PWA対応: `$ npm add -D vite-plugin-pwa`
- デプロイツール: `$ npm install -D gh-pages`

### 4. ESLint カスタム設定
`eslint.config.js` の `rules` を以下のように調整。
- `no-unused-vars: "error"`
- `react/prop-types: "off"`